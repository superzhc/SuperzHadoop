# 类加载器

## 类与类加载器

**对于任意一个类，都需要由加载它的类加载器和这个类本身一同确定其在 Java 虚拟机中的唯一性**，每一个类加载器，都拥有一个独立的类命名空间。这句话可以表达更通俗一些：比较两个类是否“相等”，只有在这两个类是由同一个类加载器加载的前提下才有意义，否则，即使这两个类来源于同一个 Class 文件，被同一个虚拟机加载，只要加载它们的类加载器不同，那这两个类就必定不相等。

## 双亲委派模型

从 Java 虚拟机的角度来讲，只存在两种不同的类加载器：一种是启动类加载器（Bootstrap ClassLoader），这个类加载器使用 C++ 语言实现，是虚拟机自身的一部分；另一种就是所有其他的类加载器，这些类加载器都由 Java 语言实现，独立于虚拟机外部，并且全都继承自抽象类 `java.lang.ClassLoader`

从 Java 开发人员的角度来看，绝大部分 Java 程序都会使用以下 3 种系统提供的类加载器：

- 启动类加载器（Bootstrap ClassLoader）

  > 这个类加载器负责将存放在`<JAVA_HOME>/lib` 目录中的，或者被 `-Xbootclasspath` 参数所指定的路径中的，并且是虚拟机识别的（仅按照文件名识别，如 rt.jar，名字不符合的类库即使放在 lib 目录中也不会被加载）类库加载到虚拟机内存中。启动类加载器无法被 Java 程序直接引用，用户在编写自定义类加载器的时，如果需要把加载请求委派给引导类加载器，那直接使用 null 代替即可。

- 扩展类加载器（Extension ClassLoader）

  > 这个加载器由 `sun.misc.Launcher$ExtClassLoader` 实现，它负责加载 `<JAVA_HOME>/lib/ext` 目录中的，或者被 `java.ext.dirs` 系统变量所指定的路径中的所有类库，开发者可以直接使用扩展类加载器

- 应用程序类加载器（Application ClassLoader）

  > 这个类加载器由 `sun.misc.Launcher$AppClassLoader` 实现。由于这个类加载器是 ClassLoader 中的 `getSystemClassLoader()` 方法的返回值，所以一般也称它为系统类加载器。它负责加载用户类路径（ClassPath）上所指定的类库，开发者可以直接使用这个类加载器，如果应用程序中没有自定义过自己的类加载器，一般情况下这个就是程序中默认的类加载器。

应用程序都是由这 3 种类加载器互相配合进行加载的，如果有必要，还可以加入自己定义的类加载器。这些类加载器之间的关系一般如下图所示：

![img](images/20160506184936657)

上图展示的类加载器之间的这种层次关系，称为类加载器的双亲委派模型（Parents Delegation Model）。双亲委派模型要求除了顶层的启动类加载器外，其余的类加载器都应当有自己的父类加载器。这里类加载器之间的父子关系一般不会以继承的关系来实现，而是都使用组合关系来复用父类加载器的代码。

> 类加载器的双亲委派模型在 JDK 1.2 期间被引入并被广泛应用于之后几乎所有的 Java 程序中，但**它并不是一个强制性的约束模型**，而是 Java 设计者推荐给开发者的一种类加载器实现方式。

双亲委派模型的工作过程是：如果一个类加载器收到了类加载的请求，它首先不会自己去尝试加载这个类，而是把这个请求委派给父类加载器去完成，每一个层次的类加载器都是如此，因此所有的加载请求最终都应该传送到顶层的启动类加载器中，只有当父加载器反馈自己无法完成这个加载请求（它的搜索范围中没有找到所需的类）时，子加载器才会尝试自己去加载。

> 注：自定义的类加载，在 `defineClass` 方法调用的时候，会先**确定保护域，并检查**：
>
> - 是否定义的是 `java.*.class`
> - 此类的签名者与包中其余类的签名者匹配
>
> 如果强行用 `defineClass()` 方法去加载一个以 `java.lang` 开头的类也不会成功。如果尝试这么做的话，将会收到一个由虚拟机自己抛出的 `java.lang.SecurityException:Prohibited package name:java.lang` 的异常 

双亲委派的具体逻辑的实现是在 `loadClass()` 方法中，JDK 1.2 之后已不提倡用户再去覆盖 `loadClass()` 方法，而应当把自己的类加载逻辑写到 `findClass()` 方法中，在 `loadClass()` 方法的逻辑里如果父类加载失败，则会调用自己的 `findClass()` 方法来完成加载，这样可以保证新写出来的类加载器是符合双亲委派规则的。