# 数据分层

对数据进行分层的一个主要的原因就是**希望在管理数据的时候，能对数据有一个更加清晰的掌控**，详细来讲，主要有下面几个原因：
1. **清晰数据结构**：每一个数据分层都有它的作用域，这样在使用表的时候能更方便地定位和理解
2. **数据血缘追踪**：简单来讲可以这样理解，我们最终给业务诚信的是一能直接使用的张业务表，但是它的来源有很多，如果有一张来源表出问题了，我们希望能够快速准确地定位到问题，并清楚它的危害范围
3. **减少重复开发**：规范数据分层，开发一些通用的中间层数据，能够减少极大的重复计算
4. **把复杂问题简单化**：讲一个复杂的任务分解成多个步骤来完成，每一层只处理单一的步骤，比较简单和容易理解。而且便于维护数据的准确性，当数据出现问题之后，可以不用修复所有的数据，只需要从有问题的步骤开始修复
5. **屏蔽原始数据的异常**
6. **屏蔽业务的影响**，不必改一次业务就需要重新接入数据

## 理论

从理论上做一个抽象可以把数据仓库分为下面三个层，即：数据运营层、数据仓库层和数据产品层

![](https://gitee.com/superzchao/GraphBed/raw/master/publish/2020/数据仓库/数据分层.png)

**ODS 全称是 Operational Data Store，操作数据存储**

数据运营层，也叫ODS层，是最接近数据源中数据的一层，数据源中的数据，经过抽取、洗净、传输，也就是 ETL，装入本层，总体上大多是按照源头业务系统的分类方式而分类的。

> 例如这一层可能包含的数据表为：人口表（包含每个人的身份证号、姓名、住址等）、机场登机记录（包含乘机人身份证号、航班号、乘机日期、起飞城市等）、银联的刷卡信息表（包含银行卡号、刷卡地点、刷卡时间、刷卡金额等）、银行账户表（包含银行卡号、持卡人身份证号等）等等一系列原始的业务数据。这里我们可以看到，这一层面的数据还具有鲜明的业务数据库的特征，甚至还具有一定的关系数据库中的数据范式的组织形式。

但是，*这一层面的数据却不等同于原始数据*。在源数据装入这一层时，要进行诸如**去噪**（例如有一条数据中人的年龄是 300 岁，这种属于异常数据，就需要提前做一些处理）、**去重**（例如在个人资料表中，同一 ID 却有两条重复数据，在接入的时候需要做一步去重）、字段**命名规范**等一系列操作。

**数据仓库层（DW），是数据仓库的主体**

在这里，从 ODS 层中获得的数据按照主题建立各种数据模型。例如以研究人的旅游消费为主题的数据集中，便可以结合航空公司的登机出行信息，以及银联系统的刷卡记录，进行结合分析，产生数据集。在这里，我们需要了解四个概念：维（dimension）、事实（Fact）、指标（Index）和粒度（ Granularity）。

**数据产品层（APP），这一层是提供为数据产品使用的结果数据**

在这里，主要是提供给数据产品和数据分析使用的数据，一般会存放在 ES、Mysql 等系统中供线上系统使用，也可能会存在 Hive 或者 Druid 中供数据分析和数据挖掘使用。 比如我们经常说的报表数据，或者说那种大宽表，一般就放在这里。

## 技术实践

这三层技术划分，相对来说比较粗粒度，后面我们会专门细分一下。在此之前，先聊一下每一层的数据一般都是怎么流向的。这里仅仅简单介绍几个常用的工具，侧重中开源界主流。

### 数据来源层 -> ODS 层

**这里其实就是现在大数据技术发挥作用的一个主要战场**。 

数据主要会有两个大的来源：
- 业务库，这里经常会使用sqoop来抽取，比如我们每天定时抽取一次。在实时方面，可以考虑用canal监听mysql的binlog，实时接入即可。
- 埋点日志，线上系统会打入各种日志，这些日志一般以文件的形式保存，我们可以选择用flume定时抽取，也可以用用spark streaming或者storm来实时接入，当然，kafka也会是一个关键的角色。
- 其它数据源会比较多样性，这和具体的业务相关，不再赘述。

![](https://gitee.com/superzchao/GraphBed/raw/master/publish/2020/数据仓库/数据抽取.png)

注意： 在这层，理应不是简单的数据接入，而是要考虑一定的数据清洗，比如异常字段的处理、字段命名规范化、时间字段的统一等，一般这些很容易会被忽略，但是却至关重要。**特别是后期我们做各种特征自动生成的时候，会十分有用**。

### ODS、DW 层 -> APP 层

这里面也主要分两种类型：
1. **每日定时任务型**：比如我们典型的日计算任务，每天凌晨算前一天的数据，早上起来看报表。 这种任务经常使用Hive、Spark或者MR程序来计算，最终结果写入Hive、HBase、Mysql、Es或者Redis中。
2. **实时数据**：这部分主要是各种实时的系统使用，比如我们的实时推荐、实时用户画像，一般我们会用Spark Streaming、Storm或者Flink来计算，最后会落入Es、Hbase或者Redis中。

## 其他

- **DWS**：轻度汇总层，从ODS层中对用户的行为做一个初步的汇总，抽象出来一些通用的维度：时间、ip、id，并根据这些维度做一些统计值，比如用户每个时间段在不同登录ip购买的商品数等。这里做一层轻度的汇总会让计算更加的高效，在此基础上如果计算仅7天、30天、90天的行为的话会快很多。我们希望80%的业务都能通过我们的DWS层计算，而不是ODS
- **DWD**：这一层主要解决一些数据质量问题和数据的完整度问题。比如用户的资料信息来自于很多不同表，而且经常出现延迟丢数据等问题，为了方便各个使用方更好的使用数据，我们可以在这一层做一个屏蔽
- **DIM**：这一层比较单纯，举个例子就明白，比如国家代码和国家名、地理位置、中文名、国旗图片等信息就存在DIM层中
- **TMP**：每一层的计算都会有很多临时表，专设一个DWTMP层来存储我们数据仓库的临时表

![](https://gitee.com/superzchao/GraphBed/raw/master/publish/2020/数据仓库/20200314235220.png)