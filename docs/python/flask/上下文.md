# Flask 上下文

> 上下文（context）可以理解为环境。为了正常运行程序，一些操作相关的状态和数据需要被临时保存下来，这些状态和数据被统称为上下文。在 Flask 中，上下文有两种，分别为程序上下文(application context)和请求上下文(request context)。

| 变量          | 上下文     | 说明                                                   |
| ------------- | ---------- | ------------------------------------------------------ |
| `current_app` | 程序上下文 | 当前激活程序的程序实例                                 |
| `g`           | 程序上下文 | 处理请求时用作临时存储的对象。每次请求都会重设这个变量 |
| `request`     | 请求上下文 | 请求对象，封装了客户端发出的HTTP请求中的内容           |
| `session`     | 请求上下文 | 用户会话，用于存储请求之间需要“记住”的值的词典         |

## request 对象

request 对象提供多个属性/方法来获取 URL 的各个部分，如下：

| 属性/方法       | 说明                                                         | 示例                                    |
| --------------- | ------------------------------------------------------------ | --------------------------------------- |
|                 | 示例                                                         | `http://helloflask.com/hello?name=Grey` |
| path            |                                                              | `/hello`                                |
| full_path       |                                                              | `/hello?name=Grey`                      |
| host            |                                                              | `helloflask.com`                        |
| host_url        |                                                              | `http://helloflask.com/`                |
| base_url        |                                                              | `http://helloflask.com/hello`           |
| url             |                                                              | `http://helloflask.com/hello?name=Grey` |
| url_root        |                                                              | `http://helloflask.com/`                |
| args            | 存储解析后的查询字符串                                       | `request.args.name`                     |
| blueprint       | 当前蓝图的名称                                               |                                         |
| cookies         |                                                              | ``                                      |
| data            | 字符串格式的请求数据                                         | ``                                      |
| endpoint        | 与当前请求相匹配的端点值                                     | ``                                      |
| files           |                                                              | ``                                      |
| form            |                                                              | ``                                      |
| values          |                                                              | ``                                      |
| `get_data(...)` | 获取请求体的数据，默认读取为字节字符串                       | ``                                      |
| `get_json(...)` | 作为 Json 解析并返回数据，如果 MIME 类型不是 JSON，返回 NONE | ``                                      |
| headers         |                                                              | ``                                      |
| is_json         | 通过 MIME 类型判断是否为 JSON 类型                           | ``                                      |
| json            | 包含解析后的 JSON 数据，内部调用 `get_json()`                | ``                                      |
| method          | 请求方法类型                                                 | ``                                      |
| referrer         |                                                              | ``                                      |
| scheme          | 请求的 URL 模式（http 或 https）                             | ``                                      |
| user_agent      | 用户代理                                                     | ``                                      |

<!--
|                 |                                                              | ``                                      |
|                 |                                                              | ``                                      |
|                 |                                                              | ``                                      |
-->

当从 request 对象的类型为 MutliDict 或 ImmutableMultiDict 的属性（比如 files、form、args）中直接使用键作为索引获取数据时（比如 `request.args['name']`），如果没有对应的键，那么会返回 HTTP 400错误响应（Bad Request，表示请求无效），而不是抛出 KeyError 异常。为了避免这个错误，应该使用 `get()` 方法获取数据，如果没有对应的值则返回 None；`get()` 方法的第二个参数可以设置默认值，比如`requset.args.get('name','Human')`。

## response 对象

视图函数可以返回最多由三个元素组成的元组：响应主体、状态码、首部字段。其中首部字段可以为字典，或者是两元素元组组成的列表。

使用 `make_response(...)` 生成 response 对象，传入响应的主体作为参数。