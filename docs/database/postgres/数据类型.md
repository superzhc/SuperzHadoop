# 数据类型

## 数字类型

> PostgreSQL 支持的数字类型有整数类型、用户指定精度类型、浮点类型、serial 类。

| 类型名称         | 存储长度 | 描述              |
| ---------------- | -------- | ----------------- |
| smallint         | 2 字节   | 小范围整数类型    |
| integer          | 4 字节   | 整数类型          |
| bigint           | 8 字节   | 大范围整数类型    |
| decimal          | 可变     |                   |
| numeric          | 可变     |                   |
| real             | 4 字节   | 变长，不精确      |
| double precision | 8 字节   | 变长，不精确      |
| smallserial      | 2 字节   | smallint 自增序列 |
| serial           | 4 字节   | integer 自增序列  |
| bigserial        | 8 字节   | bigint 自增序列   |

## 字符串类型

|字符类型名称|描述|
|character varying(n), varchar(n)|变长，字符最大数有限制|
|character(n), char(n)|定长，字符数没达到最大值则使用空白填充|
|text|变长，无长度限制|

## 布尔类型

|类型名称|存储长度|描述|
|boolean|1 字节|状态为 true 或 false|

## 时间类型

- `date`:该类型仅存储月、日、年，没有时区、小时、分和秒的信息
- `time` （又称 time without time zone ）:该类型仅存储小时、分、秒信息，不带日期和时区信息
- `timestamp` （又称 timestamp without time zone ）:该类型存储了日期（年、月、日）和时间（时、分、秒）数据，但不带时区信息。因此，即使修改了数据库服务器所在的时区信息，该类字段查询出来显示的值也是固定不变的。
- `timestamptz` （又称 timestamp with time zone ）:该类型同时存储了日期、时间以及时区信息。在系统内部，该类型的字段值是以 UTC 世界标准时间格式存储的，但当查询显示时，会按照服务器的时区设置进行换算后再显示（时区也可以在库级 / 用户级 / 会话级分别进行设置）。如果你输入的时间戳不带时区数据，那么存入 timestamptz 类型字段中时，PostgreSQL 会自动使用当前数据库服务器的时区信息来补充。如果修改了数据库服务器的时区设置，你可以看到查询出来的时间数据发生了变化。
- `timetz` （又称 time with time zone ）:与 timestamptz 类型类似，但该类型的使用频率较低，因为它虽然携带了时区信息却没有日期信息。该类型永远假设当前时间是夏令时。有的编程语言不支持这种仅有时间而无日期的数据类型，因此可能会将其自动转换为带时区的时间戳类型，转换时日期就取计算机系统时间的初始值（例如，Unix 时间纪元起始于 1970 年，因此转换后的日期就是 1970 年 1 月 1 日，时区和时间不变，夏令时）。
- `interval`:该类型描述了一个时间段的长度，单位可以是小时、天、月、分钟或者其他粒度。该类型适用于对日期和时间进行数学运算的场景。例如，假设从现在开始 666 天之后世界就会灭亡，那么你在现在的时刻上加上长度为 666 天的一个 interval 类型值，就可以知道世界灭亡的准确时刻。
- `tsrange`:该类型可用于定义 timestamp with no timezone 的开区间和闭区间。该类型包含两个时间戳以及开区间和闭区间限定符。例如，`'[2012-01-01 14:00 2012-01-01 15:00)'::tsrange` 定义了从 `14:00` 开始到 `15:00` 之前结束的一个时间段。
- `tstzrange`:该类型可用于定义 timestamp with timezone 的开区间和闭区间。
- `daterange`:该类型可用于定义日期的开区间和闭区间。

## 数组类型

> 数组类型的定义，创建表时在字段数据类型后面加方括号 `[]` 即可定义数组数据类型。

## json 类型

> PostgreSQL 在 9.2 版本提供了 json 类型

pg 支持两种 json 数据类型：

- `json`，该类型对输入的完整拷贝，使用时再去解析，所以它会保留输入的空格，重复键以及顺序等
- `jsonb`，该类型解析输入后保存的二进制，它在解析时会删除不必要的空格和重复的键，顺序和输入可能也不相同，但使用时不用再次解析

注意，json 类型的数据的键值对中的键必须使用 *双引号*。

**创建 json 类型字段**

```sql
CREATE TABLE test(
    col1 jsonb,
    col2 json
)
```

**json/jsonb 操作符**

| 操作符 | 右操作数类型 | 描述                                | 示例                                                       | 结果           |
| :----: | ------------ | ----------------------------------- | ---------------------------------------------------------- | -------------- |
|  `->`  | `int`        | 获取 JSON 数组元素（索引从 0 开始） | `select '[{"a":"foo"},{"b":"bar"},{"c":"baz"}]'::json->2;` | `{"c":"baz"}`  |
|  `->`  | `text`       | 通过键获取值                        | `select '{"a": {"b":"foo"}}'::json->'a';`                  | `{"b":"foo"}`  |
| `->>`  | `int`        | 获取 JSON 数组元素为 text           | `select '[1,2,3]'::json->>2;`                              | `3`            |
| `->>`  | `text`       | 通过键获取值为 text                 | `select '{"a":1,"b":2}'::json->>'b';`                      | `2`            |
|  `#>`  | `text[]`     | 在指定的路径获取 JSON 对象          | `select '{"a": {"b":{"c": "foo"}}}'::json#>'{a,b}';`       | `{"c": "foo"}` |
| `#>>`  | `text[]`     | 在指定的路径获取 JSON 对象为 text   | `select '{"a":[1,2,3],"b":[4,5,6]}'::json#>>'{a,2}';`      | `3`            |

**jsonb 额外操作符**

| 操作符 | 右操作数类型 | 描述                                                           | 示例                                                         | 结果                   |
| :----: | ------------ | -------------------------------------------------------------- | ------------------------------------------------------------ | ---------------------- |
|  `@>`  | `jsonb`      | 左侧 json 最上层的值是否包含右边 json 对象                     | `select '{"a":{"b":2}}'::jsonb @> '{"b":2}'::jsonb;`         | `f`                    |
|        |              |                                                                | `select '{"a":1, "b":2}'::jsonb @> '{"b":2}'::jsonb;`        | `t`                    |
|  `<@`  | `jsonb`      | 左侧 json 对象是否包含于右侧 json 最上层的值内                 | `select '{"b":2}'::jsonb <@ '{"a":1, "b":2}'::jsonb;`        | `t`                    |
|  `?`   | `text`       | text 是否作为左侧 Json 对象最上层的键                          | `select '{"a":1, "b":2}'::jsonb ? 'b';`                      | `t`                    |
| `?\|`  | `text[]`     | `text[]` 中的任一元素是否作为左侧 Json 对象最上层的键          | `select '{"a":1, "b":2, "c":3}'::jsonb ?\| array['b', 'c'];` | `t`                    |
|  `?&`  | `text[]`     | `text[]` 中的所有元素是否作为左侧 Json 对象最上层的键          | `select '["a", "b"]'::jsonb ?& array['a', 'b'];`             | `t`                    |
| `\|\|` | `jsonb`      | 连接两个 json 对象，组成一个新的 json 对象                     | `select '["a", "b"]'::jsonb \|\| '["c", "d"]'::jsonb;`       | `["a", "b", "c", "d"]` |
|  `-`   | `text`       | 删除左侧 json 对象中键为 text 的键值对                         | `select '{"a": "b"}'::jsonb - 'a';`	`{}`                     |
|  `-`   | `integer`    | 删除数组指定索引处的元素，如果索引值为负数，则从右边计算索引值 | `select '["a", "b"]'::jsonb - 1;`                            | `["a"]`                |
|  `#-`  | `text[]`     | 删除指定路径下的域或元素                                       | `select '["a", {"b":1}]'::jsonb #- '{1,b}';`                 | `["a", {}]`            |

**函数**

| 函数                                                                              | 描述                                                               |
| --------------------------------------------------------------------------------- | ------------------------------------------------------------------ |
| `to_json(anyelement)`                                                             | 返回json类型的值                                                   |
| `to_jsonb(anyelement)`                                                            | 返回jsonb类型的值                                                  |
| `array_to_json(anyarray[, pretty_bool])`                                          | 以 JSON 数组返回该数组                                             |
| `row_to_json(record [, pretty_bool])`                                             | 以JSON对象返回行                                                   |
| `json_build_array(VARIADIC "any")`                                                | 建立一个由可变参数列表组成的不同类型的JSON数组                     |
| `jsonb_build_array(VARIADIC "any")`                                               |                                                                    |
| `json_build_object(VARIADIC "any")`                                               | 建立一个由可变参数列表组成的JSON对象。参数列表参数交替转换为键和值 |
| `jsonb_build_object(VARIADIC "any")`                                              |                                                                    |
| `json_object(text[])`                                                             | 根据 `text[]` 数组建立一个 json 对象                               |
| `jsonb_object(text[])`                                                            |                                                                    |
| `json_object(keys text[], values text[])`                                         | 分别从两组text[]中获取键和值                                       |
| `jsonb_object(keys text[], values text[])`                                        |                                                                    |
| `json_array_length(json)`                                                         | 返回 Json 数组最外层元素个数                                       |
| `jsonb_array_length(jsonb)`                                                       |                                                                    |
| `json_each(json)`                                                                 | 将最外层Json对象转换为键值对集合                                   |
| `jsonb_each(jsonb)`                                                               |                                                                    |
| `json_each_text(json)`                                                            | 将最外层Json对象转换为键值对集合，且 value 为 text 类型            |
| `jsonb_each_text(jsonb)`                                                          |                                                                    |
| `json_extract_path(from_json json,VARIADIC path_elems text[])`                    | 返回path_elems指向的value，同操作符 `#>`                           |
| `jsonb_extract_path(from_json jsonb,VARIADIC path_elems text[])`                  |                                                                    |
| `json_extract_path_text(from_json json,VARIADIC path_elems text[])`               | 返回path_elems指向的value，并转为text类型，同操作符 `#>>`          |
| `jsonb_extract_path_text(from_json jsonb,VARIADIC path_elems text[])`             |                                                                    |
| `json_object_keys(json)`                                                          | 返回json对象最外层的key                                            |
| `jsonb_object_keys(jsonb)`                                                        |                                                                    |
| `json_populate_record(base anyelement,from_json json)`                            | 将json对象的value以base定义的行类型返回                            |
| `jsonb_populate_record(base anyelement,from_json jsonb)`                          |                                                                    |
| `json_populate_recordset(base anyelement,from_json json)`                         | 将json对象最外层数组以base定义的行类型返回                         |
| `jsonb_populate_recordset(base anyelement,from_json jsonb)`                       |                                                                    |
| `json_array_elements(json)`                                                       | 将json数组转换成json对象value的集合                                |
| `jsonb_array_elements(jsonb)`                                                     |                                                                    |
| `json_array_elements_text(json)`                                                  | 将json数组转换成text的value集合                                    |
| `jsonb_array_elements_text(jsonb)`                                                |                                                                    |
| `json_typeof(json)`                                                               | 返回 json 最外层value的数据类型                                    |
| `jsonb_typeof(jsonb)`                                                             |                                                                    |
| `json_to_record(json)`                                                            | 根据json对象创建一个record类型记录，必须使用as明确定义record的结构 |
| `jsonb_to_record(jsonb)`                                                          |                                                                    |
| `json_to_recordset(json)`                                                         | 根据json数组创建一个record类型记录，必须使用as明确定义record的结构 |
| `jsonb_to_recordset(jsonb)`                                                       |                                                                    |
| `json_strip_nulls(from_json json)`                                                | 返回json对象中所有非null的数据，其他的null保留                     |
| `jsonb_strip_nulls(from_json jsonb)`                                              |                                                                    |
| `jsonb_set(target jsonb, path text[],new_value jsonb[,create_missing boolean])`   |                                                                    |
| `jsonb_insert(target jsonb, path text[],new_value jsonb, [insert_after boolean])` |                                                                    |
| `jsonb_pretty(from_json jsonb)`                                                   | 以缩进的格式更容易阅读的方式返回json对象                           |

```sql
-- to_json
select to_json('3'::int);
/*
3
*/

-- json_build_array
select json_build_object('foo',1,'bar',2);
/*
{"foo" : 1, "bar" : 2}
*/

-- json_object
select json_object('{a, 1, b, "def", c, 3.5}');
select json_object('{{a, 1},{b, "def"},{c, 3.5}}');
/*
{"a" : "1", "b" : "def", "c" : "3.5"}
*/
```

## 数据类型转换

PostgreSQL数据类型转换主要有三种方式：通过格式化函数、CAST函数、`::` 操作符。

### 通过格式化函数进行转换

| 函数                       | 返回类型  | 描述                 | 示例                                           |
| -------------------------- | --------- | -------------------- | ---------------------------------------------- |
| `to_char(timestamp, text)` | text      | 把时间戳转换成字符串 | `to_char(current_timestamp, 'HH12:MI:SS')`     |
| `to_char(interval, text)`  | text      | 把间隔转换成字符串   | `to_char(interval '15h 2m 12s', 'HH24:MI:SS')` |
| `to_char(int, text)`       | text      | 把整数转换成字符串   | `to_char(125, '999')`                          |
| `to_char(numeric, text)`   | text      | 把数字转换成字符串   | `to_char(-125.8, '999D99S')`                   |
| `to_date(text, text)`      | date      | 把字符串转换成日期   | `to_date('05 Dec 2000', 'DD Mon YYYY')`        |
| `to_number(text, text)`    | numeric   | 把字符串转换成数字   | `to_number('12,454.8', '99G999D9S')`           |
| `to_timestamp(text, text)` | timestamp | 把字符串转换成时间戳 | `to_timestamp('05 Dec 2000', 'DD Mon YYYY')`   |

### 通过 CAST 函数进行转换

### 通过 `::` 操作符进行转换

