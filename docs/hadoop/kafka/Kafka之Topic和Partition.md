## Topic（主题）

Kafka 消息通过主题进行分类。Kafka 中的 Topics 总是多订阅者模式，一个 topic 可以拥有一个或多个消费者来订阅它的数据。

### Partition（分区）

在 Kafka 中，每一个主题（Topic）可以有一个或者多个分区（Partition）。在 Kafka 系统的设计思想中，分区是基于物理层面上的，不同的分区对应着不同的数据文件。

Kafka 通过分区（Partition）来支持物理层面上的并发读写，以提高 Kafka 集群的吞吐量。

每个主题（Topic）下的各分区（Partition）中存储数据的具体流程如下图所示：

![1570606883212](../images/1570606883212.png)

每一个分区（Partition）都是一个顺序的、不可变的消息队列，并且可以持续的添加。分区中的消息都被分了一个序列号，称之为偏移量（offset），在每个分区中此偏移量都是唯一的。

Kafka集群保持所有的消息，直到它们过期， 无论消息是否被消费了。 实际上消费者所持有的仅有的元数据就是这个偏移量，也就是消费者在这个分区中的位置。 这个偏移量由消费者控制：正常情况当消费者消费消息的时候，偏移量也线性的的增加。但是实际偏移量由消费者控制，消费者可以将偏移量重置为更老的一个偏移量，重新读取消息。 可以看到这种设计对消费者来说操作自如， 一个消费者的操作不会影响其它消费者对此分区的处理。

**一个分区只对应一个 broker 节点，一个 broker 节点可以管理多个分区**。

分区的作用如下：

- 当日志大小超过了单台服务器的限制，允许日志进行扩展。每个单独的分区都受限于主机的磁盘大小的限制，但一个主题可以有多个分区，因此可以处理无限量的数据
- 可以作为并行的单元集，提高处理效率

### Replication（副本）

在 Kafka 系统中，每个主题（Topic）在创建时会要求指定它的副本数，默认是 1。通过副本（Replication）机制来保证 Kafka 分布式集群数据的高可用性。

### 记录（Record）

被实际写入到 Kafka 集群并且可以被消费者应用程序读取的数据，被称为记录（Record）。每条记录包含一个键（Key）、值（Value）和时间戳（Timestamp）。

## 主题操作

使用 `kafka-topics.sh` 工具可以执行主题的大部分操作（配置变更部分已经启用并被移动到 `kafka-configs.sh` 工具当中）。可以用它创建、修改、删除和查看集群里的主题。

### 创建主题

在集群里创建一个主题需要用到 3 个参数。这些参数是必须提供的。

- 主题名字
- 复制系数
- 分区数量

**主题名字可以包含字母、数字、下划线以及英文状态下的破折号和句号**

注意：主题的名字的开头部分包含两个下划线是合法的，但不建议这么做，具有这种格式的主题一般是集群的内部主题。也不建议在单个集群里使用英文状态下的句号和下划线来命名，因为主题的名字会被用在度量指标上，句号会被替换成下划线（比如 `topic.1` 会变成 `topic_1`）

### 增加分区

主题基于分区进行伸缩和复制，增加分区主要是为了扩展主题容量或者降低单个分区的吞吐量。如果要在单个消费者群组内运行更多的消费者，那么主题的数量也需要相应的增加，因为一个分区只能由群组里的一个消费者读取。

**减少分区数量**

无法减少主题的分区数量。因为删除了分区，分区里的数据也一并被删除，导致数据不一致，因为无法将这些数据分配给其他分区，且也会出现消息乱序的问题。所以，如果一定要减少分区数量，只能删除整个主题，然后重新创建它。

### 删除主题

如果一个主题不再被使用，只要它还存在于集群里，就会占用一定数量的磁盘空间和文件句柄，把它删除就可以释放被占用的资源。为了能够删除主题，broker 的 `delete.topic.enable` 参数必须被设置为 true。如果该参数被设置为 false，删除主题的请求会被忽略。

注：删除主题会丢弃主题里的所有数据。这是一个不可逆的操作，所以在执行时要小心。

### 列出集群里的所有主题

