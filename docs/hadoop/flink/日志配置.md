# Flink 日志配置

Flink 中日志记录是使用 slf4j 日志接口进行记录的，默认使用 log4j2 为底层实现。

Flink 附带以下默认日志配置文件：

- `log4j-cli.properties`：由 Flink 命令行客户端使用（例如 flink run）（不包括在集群上执行的代码）
- `log4j-session.properties`：Flink 命令行客户端在启动 YARN 或 Kubernetes session 时使用（`yarn-session.sh`，`kubernetes-session.sh`）
- `log4j.properties`：作为 JobManager/TaskManager 日志配置使用（standalone 和 YARN 两种模式下皆使用）

## 不同生命周期使用不同的日志配置文件

### 启动 `yarn-session`

启动 `yarn-session` 执行如下脚本：

```shell
yarn-session.sh  -d -jm 1024 -tm 4096 -s 12
```

`yarn-session.sh` 脚本有如下代码：

```shell
log=$FLINK_LOG_DIR/flink-$FLINK_IDENT_STRING-yarn-session-$HOSTNAME.log
log_setting="-Dlog.file="$log" -Dlog4j.configuration=file:"$FLINK_CONF_DIR"/log4j-session.properties -Dlog4j.configurationFile=file:"$FLINK_CONF_DIR"/log4j-session.properties -Dlogback.configurationFile=file:"$FLINK_CONF_DIR"/logback-session.xml"

//... 
// java启动程序中引入log_setting
// java ... "${log_setting}"
```

### 执行 flink 提交任务

提交任务执行如下命令：

```shell
flink run xxx.jar
```

其中 flink 有如下命令：

```shell
log=$FLINK_LOG_DIR/flink-$FLINK_IDENT_STRING-client-$HOSTNAME.log
log_setting=(-Dlog.file="$log" -Dlog4j.configuration=file:"$FLINK_CONF_DIR"/log4j-cli.properties -Dlog4j.configurationFile=file:"$FLINK_CONF_DIR"/log4j-cli.properties -Dlogback.configurationFile=file:"$FLINK_CONF_DIR"/logback.xml)

//... 
// java启动程序中引入log_setting
// java ... "${log_setting}"
```

### JobManager/TaskManager 运行

当 Job 提交成功后，Yarn 会为 Job 启动 JobManager/TaskManager，会执行 `jobmanager.sh`/`taskmanager.sh`，这两个脚本都存在如下代码：

```shell
if [[ $STARTSTOP == "start-foreground" ]]; then
    # 前端操作
    exec "${FLINK_BIN_DIR}"/flink-console.sh $ENTRYPOINT "${args[@]}"
else 
    # 后端操作
    "${FLINK_BIN_DIR}"/flink-daemon.sh $STARTSTOP $ENTRYPOINT "${args[@]}"
fi
```

对后端操作 `flink-daemon.sh` 脚本进行分析，该脚本有如下代码：

```shell
FLINK_LOG_PREFIX="${FLINK_LOG_DIR}/flink-${FLINK_IDENT_STRING}-${DAEMON}-${id}-${HOSTNAME}"
log="${FLINK_LOG_PREFIX}.log"
out="${FLINK_LOG_PREFIX}.out"

log_setting=("-Dlog.file=${log}" "-Dlog4j.configuration=file:${FLINK_CONF_DIR}/log4j.properties" "-Dlog4j.configurationFile=file:${FLINK_CONF_DIR}/log4j.properties" "-Dlogback.configurationFile=file:${FLINK_CONF_DIR}/logback.xml")

//... 
// java启动程序中引入log_setting
// java ... "${log_setting}"
```