# S2S 协议（站点到站点协议）

> S2S 协议是在两个NiFi实例之间传输数据的协议，两端可以是独立的 NiFi 或 NiFi 集群。

特点：

- 易于配置：输入远程 NiFi 实例的 URL 后，将自动发现可用端口(端点)并在下拉列表中提供；
- 安全：站点到站点可选地使用证书来加密数据并提供身份验证和授权；
- 可扩展：随着远程集群中的节点发生更改，将自动检测这些更改，并在集群中的所有节点上扩展数据；
- 高效：站点到站点允许立即发送批量的 FlowFiles，以避免建立连接和在对等点之间进行多次往返请求的开销；
- 可靠：校验由发送方和接收方自动生成，并在数据传输后进行比较，以确保没有发生损坏；如果校验和不匹配,则会取消交易并再次尝试；
- 自动加载平衡：当节点联机或退出远程集群，或节点的负载变得更重或更轻时，将自动调整定向到该节点的数据量；
- FlowFile 保留属性：当通过此协议传输FlowFile时，所有FlowFile的属性都会随之自动传输；
- 适应性强

> 为了通过 S2S 协议与远程 NiFi 实例进行通信，只需将 **远程进程组** 拖到画布上，然后输入远程 NiFi 实例的 URL。

S2S 通信步骤：

1. 客户端通过向指定的远程 URL 发送 HTTP(S) 请求来获取站点到站点协议，以获取远程集群站点到站点信息。具体来说，到 `/NiFi-api/site-to-site`，调用此请求 SiteToSiteDetail；
2. 远程 NiFi 节点响应其输入和输出端口，以及 RAW 和 TCP 传输协议的 TCP 端口号；
3. 客户端使用 `#2` 返回的 TCP 端口号发送另一个请求以获取远程对等方。根据此请求，原始套接字通信用于 RAW 传输协议，而 HTTP 继续使用 HTTP(S)，调用此请求Peers；
4. 远程NiFi节点使用包含主机名，端口，安全性和工作负载(例如排队的FlowFiles数)的可用远程对等体列表进行响应。从这一点开始，在客户端和远程NiFi节点之间进行进一步的通信；
5. 客户端根据工作负载信息决定从哪个对等方传输数据；
6. 客户端向远程NiFi节点发送创建事务的请求；
7. 远程NiFi节点接受该事务；
8. 数据被发送到目标对等方。可以批量发送多个数据包；
9. 当没有更多数据要发送或达到批量限制时，通过计算发送数据的CRC32哈希来确认两端的事务；
10. 数据传输在两端都有。