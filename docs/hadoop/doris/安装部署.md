# 安装部署

## 环境配置

**关闭交换分区**

```sh
# 查看 Swap 状态
free -m

# 使用如下命令临时关闭交换分区
swapoff -a
# 永久关闭需要到 /etc/fstab 中注释掉 swap 分区
```

**设置系统最大打开文件句柄数**

*临时设置*

```sh
ulimit -n 65536
```

*永久设置*

```
vi /etc/security/limits.conf

* soft nofile 65536
* hard nofile 65536
```

**调整 `vm.max_map_count` 的大小**

> max_map_count 文件包含限制一个进程可以拥有的VMA(虚拟内存区域)的数量

*临时设置*

```sh
sysctl -w vm.max_map_count=2000000
```

*永久设置*

```
vim /etc/sysctl.conf

vm.max_map_count=2000000
```

<!--

**时钟同步**

见[时钟同步](../../linux/NTP服务.md)

-->

**JDK8 安装**

见：[JDK安装](../../java/安装部署.md)

**查看 GCC 的版本**

```sh
# doris v1.2 要求 GCC 的版本为 4.8.2 及以上
gcc --version
```

**关闭防火墙**

见[关闭防火墙](../../linux/防火墙.md)

## 下载

官方下载界面：<https://doris.apache.org/zh-CN/download/>

**解压**

```sh
# 示例
tar -xvf apache-doris-1.2.4.1-bin-x86_64.tar.xz
```

## FE 部署

**配置文件（`fe.conf`）**

```sh
# 该参数必须配置，见：https://doris.apache.org/zh-CN/docs/1.2/get-starting/
priority_networks=172.23.16.0/24

# 设置 meta_dir
meta_dir = /data/doris
# JAVA_OPTS 中最大堆内存调整到 8G
```

**启动 FE**

```sh
./bin/start_fe.sh --daemon
```

*集群部署情况下*

```sh
./bin/start_fe.sh --helper leader_fe_host:edit_log_port --daemon
# 其中 leader_fe_host 为 Master 所在节点 ip, edit_log_port 在 Master 的配置文件 fe.conf 中。--helper 参数仅在 follower 和 observer 第一次启动时才需要。
```

**添加 FE 节点**

```sql
-- 添加 FOLLOWER
ALTER SYSTEM ADD FOLLOWER "follower_host:edit_log_port";

-- 添加 OBSERVER
ALTER SYSTEM ADD OBSERVER "observer_host:edit_log_port";
```

**删除 FE 节点**

```sql
ALTER SYSTEM DROP FOLLOWER[OBSERVER] "fe_host:edit_log_port";
```

**查看 FE 状态**

```sql
SHOW PROC '/frontends';
-- 或者
show frontends;
```

**访问界面**

<http://fe_ip:8030>

## BE 部署

**检查服务器是否支持 AVX/AVX2**

```sh
grep avx /proc/cpuinfo

grep avx2 /proc/cpuinfo
```

<!--
**操作系统设置**

```sh
sysctl -w vm.max_map_count=2000000

# 临时设置文件句柄数
ulimit -n 65536

# 设置系统最大打开文件句柄数
vi /etc/security/limits.conf

* soft nofile 65536
* hard nofile 65536
```
-->

**配置文件**

```sh
# 数据存放目录
storage_root_path = /data/doris

# 该参数必须配置，见：https://doris.apache.org/zh-CN/docs/1.2/get-starting/
priority_networks=172.23.16.0/24
```

**启动 BE**

```sh
# --daemon 后台启动模式，首次建议不添加该参数，当能与 FE 通信后，再已后台运行的模式进行启动
./bin/start_be.sh --daemon
```

**添加 BE 节点到集群**

> 通过 MySQL 客户端连接到 FE 之后，执行如下 SQL 将 BE 添加到集群中

```sql
ALTER SYSTEM ADD BACKEND "be_host_ip:heartbeat_service_port";
```

**删除 BE 节点**

```sql
-- 不推荐使用
ALTER SYSTEM DROPP BACKEND "be_host:be_heartbeat_service_port";

-- 安全删除节点的语句
ALTER SYSTEM DECOMMISSION BACKEND "be_host:be_heartbeat_service_port";
```

**查看 BE 状态**

```sql
SHOW PROC '/backends';
-- 或者
show backends;
```

## Broker 部署

**启动 Broker**

```sh
./bin/start_broker.sh --daemon
```

**添加 Broker**

```sql
-- 其中 broker_host 为 Broker 所在节点 ip；broker_ipc_port 在 Broker 配置文件中的conf/apache_hdfs_broker.conf
ALTER SYSTEM ADD BROKER broker_name "broker_host1:broker_ipc_port1","broker_host2:broker_ipc_port2",...;
```

**查看 Broker 状态**

```sql
SHOW PROC "/brokers";
```